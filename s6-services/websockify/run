#!/usr/bin/with-contenv sh

# Ensure log directory exists
mkdir -p /app/logs

# Wait for the X server to become available before launching Selkies.
# When Selkies starts too early pynput fails to connect to the display
# which causes an ImportError and the service restarts in a loop.
if [ -n "${DISPLAY}" ]; then
  for _ in $(seq 1 30); do
    if xset q >/dev/null 2>&1; then
      break
    fi
    sleep 1
  done
fi

# Completely disable X Shared Memory usage.  The container environment
# lacks proper MIT-SHM support which causes Selkies to abort if the
# extension is enabled.
export SELKIES_DISABLE_XSHM=1
export PIXELFLUX_DISABLE_XSHM=1
# Explicitly disable audio to avoid PulseAudio device errors on systems
# without proper sound hardware.
export SELKIES_DISABLE_AUDIO=1

# Launch Selkies in websocket mode with XSHM and audio disabled.
exec selkies --addr="localhost" --mode="websockets" \
    --disable-xshm --no-audio >> /app/logs/selkies.log 2>&1
