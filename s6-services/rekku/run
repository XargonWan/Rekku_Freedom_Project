#!/command/with-contenv bash
set -e

ABC_USER=abc
ABC_UID=$(id -u "$ABC_USER")
ABC_GID=$(id -g "$ABC_USER")

# Define the abc user's home without altering root's HOME
ABC_HOME=/config
XDG_CONFIG_HOME="${ABC_HOME}/.config"

# Ensure XDG config locations exist and are owned by abc
mkdir -p "$XDG_CONFIG_HOME" "$XDG_CONFIG_HOME/chromium-rfp" /home/rekku/.config || true
chown -R "$ABC_UID:$ABC_GID" "$XDG_CONFIG_HOME" /home/rekku/.config || true
chmod 700 "$XDG_CONFIG_HOME" 2>/dev/null || true

echo "[S6 Rekku] Pulizia processi precedenti..."
HOME="$ABC_HOME" XDG_CONFIG_HOME="$XDG_CONFIG_HOME" /usr/local/bin/cleanup_chrome.sh || true

# Re-assert ownership of /config after root-level cleanup
chown -R "$ABC_UID:$ABC_GID" "$ABC_HOME" || true
chmod -R ug+rwX "$ABC_HOME" || true

echo "[S6 Rekku] Attendo /tmp/.X11-unix/X1..."
while [ ! -e /tmp/.X11-unix/X1 ]; do
    sleep 2
    echo "[S6 Rekku] Still waiting for /tmp/.X11-unix/X1..."
done

echo "[S6 Rekku] Avvio Rekku Freedom Project..."
cd /app
LOG_DIR=/app/logs
mkdir -p "$LOG_DIR"
chown "$ABC_UID:$ABC_GID" "$LOG_DIR" || true
exec s6-setuidgid abc env HOME="$ABC_HOME" XDG_CONFIG_HOME="$XDG_CONFIG_HOME" LOG_DIR="$LOG_DIR" /usr/local/bin/rekku.sh run
